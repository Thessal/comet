module TestComplex

import StdLib
import Data.Universe

// Strategy Definition
strategy :: Series Real -> Series Real
strategy vol =
    let
        // Synthesis Point 1: Historical transform
        avg_vol = moving_average(vol, 21)

        // Synthesis Point 2: Comparator
        // Assuming 'compare' is brought in by StdLib or we use the operator
        // If we use the class instance from StdLib:
        spike = vol / avg_vol 

        // Synthesis Point 3: Normalizer
        score = normalize(spike)

        // Trigger logic
        sig = trigger(vol, score, 4.0)
    in
        sig

// 3. Helper Functions

// Simple moving average
moving_average(s: Series a, w: Int) -> Series Real
moving_average(s, w) = mean(rolling(s, w))

// Trigger
trigger(target: DataFrame a, score: DataFrame b, thresh: Real) -> DataFrame a | Normalized b
trigger(target, score, thresh) = update_when(target, score > thresh)
